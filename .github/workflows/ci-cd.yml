name: Cloud-Agnostic CI/CD

on:
  push:
    branches: [ master ]

env:
  APP_NAME: go-cloud-demo
  GCP_ENABLED: ${{ secrets.GCP_ENABLED }}
  AZURE_ENABLED: ${{ secrets.AZURE_ENABLED }}
  AWS_ENABLED: ${{ secrets.AWS_ENABLED }}
  CLOUD_PROVIDER: ${{ secrets.CLOUD_PROVIDER }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code
      - uses: actions/checkout@v4

      # 2. Set up Go
      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      # 3. Run Go tests
      - name: Run Tests
        run: go test ./... -v

      # 4. Build Docker image (neutral tag)
      - name: Build Docker Image
        run: |
          echo "Building Docker image for provider: $CLOUD_PROVIDER"
          docker build \
            --build-arg CLOUD_PROVIDER=${{ env.CLOUD_PROVIDER }} \
            -t $APP_NAME:latest .

      ####################################################################
      # DEPLOY TO GCP
      ####################################################################
      - name: Deploy to Google Cloud
        if: ${{ env.GCP_ENABLED == 'true' }}
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          REGION: ${{ secrets.GCP_REGION }}
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          echo "$GCP_SA_KEY" > key.json
          gcloud auth activate-service-account --key-file=key.json
          gcloud auth configure-docker $REGION-docker.pkg.dev --quiet

          GCP_IMAGE="$REGION-docker.pkg.dev/$PROJECT_ID/demo-repo/$APP_NAME"

          echo "Pushing image to Google Artifact Registry..."
          docker tag $APP_NAME:latest $GCP_IMAGE:latest
          docker push $GCP_IMAGE:latest

          echo "Deploying to Cloud Run..."
          gcloud run deploy $APP_NAME \
            --image $GCP_IMAGE:latest \
            --region $REGION \
            --platform managed \
            --project $PROJECT_ID \
            --allow-unauthenticated

      ####################################################################
      # Minimal Azure Deploy
      ####################################################################
      - name: Deploy to Azure
        if: ${{ env.AZURE_ENABLED == 'true' }}
        env:
          AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
        run: |
          echo "Logging into Azure..."
          echo "${AZURE_CREDENTIALS}" > azure.json
          CLIENT_ID=$(jq -r .clientId azure.json)
          CLIENT_SECRET=$(jq -r .clientSecret azure.json)
          TENANT_ID=$(jq -r .tenantId azure.json)
          SUBSCRIPTION_ID=$(jq -r .subscriptionId azure.json)

          az login --service-principal \
            --username $CLIENT_ID \
            --password $CLIENT_SECRET \
            --tenant $TENANT_ID
          az account set --subscription $SUBSCRIPTION_ID

          ACR="mydemoacrgo.azurecr.io"
          AZURE_IMAGE="$ACR/$APP_NAME:latest"

          echo "Logging in to ACR..."
          az acr login --name mydemoacrgo

          echo "Pushing image to ACR..."
          docker tag $APP_NAME:latest $AZURE_IMAGE
          docker push $AZURE_IMAGE

          echo "Deploying to Azure Container Apps..."
          az containerapp update \
            --name go-cloud-demo \
            --resource-group my-demo-rg \
            --image $AZURE_IMAGE \
            --output table

      ####################################################################
      #AWS Deploy (from AWS_CREDENTIALS.json)
      ####################################################################
      - name: Deploy to AWS
        if: ${{ env.AWS_ENABLED == 'true' }}
        env:
          AWS_JSON: ${{ secrets.AWS_CREDENTIALS }}
        run: |
          echo "Loading AWS credentials JSON..."
          echo "$AWS_JSON" > aws.json

          AWS_ACCESS_KEY_ID=$(jq -r .accessKeyId aws.json)
          AWS_SECRET_ACCESS_KEY=$(jq -r .secretAccessKey aws.json)
          AWS_ACCOUNT_ID=$(jq -r .accountId aws.json)
          REGION=$(jq -r .region aws.json)
          SERVICE_NAME="go-cloud-demo"

          echo "Configuring AWS CLI..."
          aws configure set aws_access_key_id "$AWS_ACCESS_KEY_ID"
          aws configure set aws_secret_access_key "$AWS_SECRET_ACCESS_KEY"
          aws configure set default.region "$REGION"

          ECR_IMAGE="$AWS_ACCOUNT_ID.dkr.ecr.$REGION.amazonaws.com/$APP_NAME:latest"

          echo "Logging in to ECR..."
          aws ecr get-login-password --region $REGION \
            | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$REGION.amazonaws.com

          echo "Tagging and pushing image to ECR..."
          docker tag $APP_NAME:latest $ECR_IMAGE
          docker push $ECR_IMAGE

          echo "Checking if App Runner service exists..."
          SERVICE_ARN=$(aws apprunner list-services --query "ServiceSummaryList[?ServiceName=='$SERVICE_NAME'].ServiceArn" --output text)

          if [ "$SERVICE_ARN" = "None" ] || [ -z "$SERVICE_ARN" ]; then
            echo "Creating App Runner service..."
            aws apprunner create-service \
              --service-name "$SERVICE_NAME" \
              --source-configuration ImageRepository="{ImageIdentifier=\"$ECR_IMAGE\",ImageRepositoryType=\"ECR\"}" \
              --auto-deployments-enabled
          else
            echo "Updating App Runner service..."
            aws apprunner update-service \
              --service-arn "$SERVICE_ARN" \
              --source-configuration ImageRepository="{ImageIdentifier=\"$ECR_IMAGE\",ImageRepositoryType=\"ECR\"}"
          fi

          echo "âœ” AWS Deployment Complete"
