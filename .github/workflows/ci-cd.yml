name: Cloud-Agnostic CI/CD

on:
  push:
    branches: [ master ]

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.GCP_REGION }}
  IMAGE: ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/demo-repo/go-cloud-demo
  AZURE_ENABLED: ${{ secrets.AZURE_ENABLED }}
  AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
  AZURE_REGISTRY_NAME: ${{ secrets.AZURE_REGISTRY_NAME }}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout source code
      - uses: actions/checkout@v4

      # 2. Set up Go
      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      # 3. Run Go tests
      - name: Run Tests
        run: go test ./... -v

      # 4. Authenticate to Google Cloud
      - name: Authenticate to Google Cloud
        run: |
          echo '${{ secrets.GCP_SA_KEY }}' > key.json
          gcloud auth activate-service-account --key-file=key.json
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      # 5. Build Docker Image
      - name: Build Docker Image
        run: docker build -t $IMAGE:$GITHUB_SHA -t $IMAGE:latest .

      # 6. Push Image to Google Artifact Registry
      - name: Push Docker Image
        run: |
          docker push $IMAGE:$GITHUB_SHA
          docker push $IMAGE:latest

      # 7. Deploy to Google Cloud Run
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy go-cloud-demo \
            --image $IMAGE:$GITHUB_SHA \
            --region ${{ env.REGION }} \
            --platform managed \
            --project ${{ env.PROJECT_ID }} \
            --allow-unauthenticated \

      # 8. Mirror Image to Azure ACR (optional)
      - name: Mirror to Azure ACR
        if: ${{ env.AZURE_ENABLED == 'true' }}
        run: |
          echo "Azure mirroring enabled: $AZURE_ENABLED"
          az login --service-principal \
            -u $(echo $AZURE_CREDENTIALS | jq -r .clientId) \
            -p $(echo $AZURE_CREDENTIALS | jq -r .clientSecret) \
            --tenant $(echo $AZURE_CREDENTIALS | jq -r .tenantId)
          az acr login --name $AZURE_REGISTRY_NAME
          docker tag $IMAGE:latest $AZURE_REGISTRY_NAME.azurecr.io/go-cloud-demo:latest
          docker push $AZURE_REGISTRY_NAME.azurecr.io/go-cloud-demo:latest

      # 9. Deploy to Azure Container App
      - name: Deploy to Azure Container Apps
        if: ${{ env.AZURE_ENABLED == 'true' }}
        run: |
          az login --service-principal \
            -u $(echo $AZURE_CREDENTIALS | jq -r .clientId) \
            -p $(echo $AZURE_CREDENTIALS | jq -r .clientSecret) \
            --tenant $(echo $AZURE_CREDENTIALS | jq -r .tenantId)

          echo "Deploying container to Azure Container App..."

          # Check if the Container App exists
          if az containerapp show --name go-cloud-demo --resource-group Stuff > /dev/null 2>&1; then
            echo "Updating existing container app..."
            az containerapp update \
              --name go-cloud-demo \
              --resource-group Stuff \
              --image $AZURE_REGISTRY_NAME.azurecr.io/go-cloud-demo:latest \
              --set-env-vars "CLOUD_PROVIDER=AZURE"
          else
            echo "Creating new container app..."
            az containerapp create \
              --name go-cloud-demo \
              --resource-group Stuff \
              --environment go-cloud-demo-env \
              --image $AZURE_REGISTRY_NAME.azurecr.io/go-cloud-demo:latest \
              --target-port 8080 \
              --ingress external \
              --registry-server $AZURE_REGISTRY_NAME.azurecr.io \
              --set-env-vars "CLOUD_PROVIDER=AZURE"
          fi

      # 10. Mirror Image to AWS ECR (optional)
      - name: Mirror to AWS ECR
        if: ${{ env.AWS_ENABLED == 'true' }}
        env:
          AWS_ENABLED: ${{ secrets.AWS_ENABLED }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
        run: |
          echo "AWS mirroring enabled: $AWS_ENABLED"
          aws configure set aws_access_key_id "$AWS_ACCESS_KEY_ID"
          aws configure set aws_secret_access_key "$AWS_SECRET_ACCESS_KEY"
          aws ecr get-login-password --region ap-southeast-2 | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.ap-southeast-2.amazonaws.com
          docker tag $IMAGE:latest $AWS_ACCOUNT_ID.dkr.ecr.ap-southeast-2.amazonaws.com/go-cloud-demo:latest
          docker push $AWS_ACCOUNT_ID.dkr.ecr.ap-southeast-2.amazonaws.com/go-cloud-demo:latest
