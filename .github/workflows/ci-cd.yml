name: Cloud-Agnostic CI/CD

on:
  push:
    branches: [ master ]

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.GCP_REGION }}
  IMAGE: ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/demo-repo/go-cloud-demo
  AZURE_ENABLED: ${{ secrets.AZURE_ENABLED }}
  AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
  AZURE_REGISTRY_NAME: ${{ secrets.AZURE_REGISTRY_NAME }}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout source code
      - uses: actions/checkout@v4

      # 2. Set up Go
      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      # 3. Run Go tests
      - name: Run Tests
        run: go test ./... -v

      # 4. Authenticate to Google Cloud
      - name: Authenticate to Google Cloud
        run: |
          echo '${{ secrets.GCP_SA_KEY }}' > key.json
          gcloud auth activate-service-account --key-file=key.json
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      # 5. Build Docker Image
      - name: Build Docker Image
        run: docker build -t $IMAGE:$GITHUB_SHA -t $IMAGE:latest .

      # 6. Push Image to Google Artifact Registry
      - name: Push Docker Image
        run: |
          docker push $IMAGE:$GITHUB_SHA
          docker push $IMAGE:latest

      # 7. Deploy to Google Cloud Run
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy go-cloud-demo \
            --image $IMAGE:$GITHUB_SHA \
            --region ${{ env.REGION }} \
            --platform managed \
            --project ${{ env.PROJECT_ID }} \
            --allow-unauthenticated \

      # 8. Mirror & Deploy to Azure
      - name: Mirror & Deploy to Azure
        if: ${{ env.AZURE_ENABLED == 'true' }}
        env:
          AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
          AZURE_REGISTRY_NAME: ${{ secrets.AZURE_REGISTRY_NAME }}
          AZURE_CONTAINERAPP_NAME: go-cloud-demo
          AZURE_RESOURCE_GROUP: Stuff
        run: |
          echo "Mirroring and deploying to Azure..."

          # Login using Service Principal
          az login --service-principal \
            -u $(echo "$AZURE_CREDENTIALS" | jq -r .clientId) \
            -p $(echo "$AZURE_CREDENTIALS" | jq -r .clientSecret) \
            --tenant $(echo "$AZURE_CREDENTIALS" | jq -r .tenantId)

          # Push to Azure ACR
          az acr login --name $AZURE_REGISTRY_NAME
          docker tag $IMAGE:latest $AZURE_REGISTRY_NAME.azurecr.io/go-cloud-demo:latest
          docker push $AZURE_REGISTRY_NAME.azurecr.io/go-cloud-demo:latest

          # Deploy (update container app)
          echo "Updating Azure Container App..."
          az containerapp update \
            --name $AZURE_CONTAINERAPP_NAME \
            --resource-group $AZURE_RESOURCE_GROUP \
            --image $AZURE_REGISTRY_NAME.azurecr.io/go-cloud-demo:latest \
            --output table

          echo "Azure deployment complete.



      # 10. Mirror Image to AWS ECR (optional)
      - name: Mirror to AWS ECR
        if: ${{ env.AWS_ENABLED == 'true' }}
        env:
          AWS_ENABLED: ${{ secrets.AWS_ENABLED }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
        run: |
          echo "AWS mirroring enabled: $AWS_ENABLED"
          aws configure set aws_access_key_id "$AWS_ACCESS_KEY_ID"
          aws configure set aws_secret_access_key "$AWS_SECRET_ACCESS_KEY"
          aws ecr get-login-password --region ap-southeast-2 | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.ap-southeast-2.amazonaws.com
          docker tag $IMAGE:latest $AWS_ACCOUNT_ID.dkr.ecr.ap-southeast-2.amazonaws.com/go-cloud-demo:latest
          docker push $AWS_ACCOUNT_ID.dkr.ecr.ap-southeast-2.amazonaws.com/go-cloud-demo:latest
